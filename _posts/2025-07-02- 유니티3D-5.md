---
title: 유니티3D - 5
date: 2025-07-02 15:00:00 +09:00
categories: [유니티,3D]
tags:
  [
    유니티, 3D
  ]
---
## 이번 목표
총 오토모드

### 오토모드 구조
오토모드를 위해 좌클릭 누름/해제를 구분해야 한다.  
`context.performed`와 `context.canceled`를 이용해 WeaponComponent의 On/Off 경로를 명확히 나눈다.  
```c#
    public void OnFire(InputAction.CallbackContext context)
    {
        if (context.performed)
        {
            weapon.L_Attack();
        }
        else if (context.canceled)
        {
            weapon.L_OffAttack();
        }
    }
```

그 후 GunWeapon에 OffFire() 함수를 추가하여 구현하도록 해주자.
```c#
    public void L_Attack()
    {
        if(Aiming)
        {
            CurrentWeapon.OnFire();
            OnFireEvent.Invoke();
        }
    }

    public void L_OffAttack()
    {
        CurrentWeapon.OffFire();
    }
```
기존에는 OnFire() 즉시 fire()로 연결했지만, 이제 `firing` 플래그와 코루틴으로 연사를 제어한다. 

```c#
    public void OnFire()
    {
        if (firing == true) return;
        firing = true;

        if (data.auto)
        {
            StartCoroutine("FireLoop");
        }
        else
        {
            fire();
        }
    }
    public void OffFire()
    {
        firing = false;
        if (data.auto)
        {
            StopCoroutine("FireLoop");
        }
    }

    private IEnumerator FireLoop()
    {
        while (true)
        {
            fire();
            yield return new WaitForSeconds(data.delayTime);
        }
    }
```

문제: 발사 애니메이션이 WeaponComponent 경유 델리게이트로만 트리거되어 타이밍이 어긋난다. 
해결: 애니메이션 트리거를 실제 발사(fire) 지점으로 옮겨 시각/논리 타이밍을 일치시킨다.
그리고 단발을 광클하면 연사보다 빨라지는 문제가 있었다. 이를 막기 위해 발사 간격을 강제하는 플래그/코루틴을 추가했다.  
```c#

    public void OnFire()
    {
        if (firing == true) return;
        firing = true;

        if (data.auto)
        {
            StartCoroutine("FireLoop");
        }
        else
        {
            fire();
        }
       
    }
    public void OffFire()
    {
        firing = false;

        if (data.auto)
        {
            StopCoroutine("FireLoop");
        }
    }

    private IEnumerator FireLoop()
    {
        while (true)
        {
            fire();
            yield return new WaitForSeconds(data.delayTime);
        }
    }

    private IEnumerator FireTimer()
    {
        yield return new WaitForSeconds(data.delayTime);
        bCanFire = true;
    }

    // 추가한 부분
     public virtual void fire()
     {
       if (bCanFire == false) return;
       bCanFire = false;
       StartCoroutine("FireTimer");
     }
```
정리: fire() 진입 시 bCanFire=false로 잠그고, 딜레이 후 true로 풀어 연사 간격 하한을 보장한다. 
애니메이션 트리거도 fire()에서 수행해 연사/단발 모두 정합성을 확보한다.  
총기 추가를 고려하면 델리게이트 인자로 무기 타입을 넘겨 애니메이션 분기를 단순화할 수 있다. 
WeaponComponent → GunWeapon로 구독 위치를 이동할 때는 “무기 장착 타이밍에 구독/해제”가 맞다. 장착 전/후 시점이 어긋나면 Null 이슈가 난다.
AI도 같은 컴포넌트를 사용할 예정이라, 발사/애니메이션/UI 이벤트는 무기 단에 일원화하고 입력만 각 컨트롤러가 담당하면 유지보수가 수월하다.  


