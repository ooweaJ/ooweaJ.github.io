---
title: 언리얼 모션매칭
date: 2024-11-27 14:00:00 +09:00
categories: [언리얼, 모션매칭]
tags:
  [
    언리얼, 모션매칭
  ]
---
# **개발일지를 작성하게된 이유**
1. **문제 해결 과정 추적**
- 개발 중 발생한 문제와 그에 대한 해결 방법을 기록하면, 나중에 비슷한 문제를 만났을 때 쉽게 참고하기위해
2. **성장 기록**
- 쉽게 생각나지 않는 기능 구현, 머티리얼 관련 내가 약한 부분을 기록하여 나중에 복습하기위해
3. **버그 추적 및 디버깅**
- 1번과 비슷한 버그 추적 및 디버깅 기록을 남기면, 버그 발생 원인과 해결 과정을 명확히 기록하여 참고하기 위해
4. **변경 사항 및 아이디어 기록**
- 개발을 하다가보면 클래스 구조나 기능을 구현하다 더 좋은 아이디어가 생각나서 즉석으로 변경할 때 기록하여 다시 변경 사항을 되돌릴 상황에 유용할 것 같다.

GameAnimationSample 의 캐릭터 구조를 가져와보자

일단 플러그인을 추가하자 Motion Warping, Animation Locomotion Library, Animation Warping

씬캡쳐에 

모션매칭 기능을 사용하기 위해서는 
기본 구성 요소
- 포즈 서치 스키마 : 포즈 서치 데이터베이스와 쿼리 시스템을 모션 매칭 노드에 연결하는 데에 사용 그 애니메이션을 선택을 위해 쿼리에 사용할 데이터를 정의하는 곳 ( 위치 속도 방향)
- 포즈 서치 데이터베이스 : 스키마 정보를 기반으로 데이터베이스 에셋을 만들고 애니메이션을 추가 후 각포즈들에서 스키마에서 정의한대로 커리 정보를 데이터베이스에 저장한다. 애니메이션을 추가 하여 캐릭터가 더 많은 동작을 하고 사전에 루트 모션으로 작업이 되어있어야 한다.
 그 이유로는 모션매칭이 애니메이션이 어떤 방향으로 어떤 속드로 움직이는지 알수가 없기때문이다.
- ABP에서 모션 매칭 노드 & 포즈 히스토리 노드 : 모션 매칭노드에 데이터베이스 연결 데이터베이스에서 포즈를 검색함, 실시간으로 매칭할 커리 정보를 만들어주는 포즈 히스토리 노드이다.
데이터베이스를 각 동작별로 여러개로 나누어 사용하는게 더 동적으로 표현하기 때문에 이 방식을 사용하자. 다른 동작에 영향 없으 가중치를 조절해줄수있다.

리와인드 디버거 - 모션 매칭을 디버깅하기 유용한 툴  툴메뉴 -> 디버거 -> 리와인드 디버거
애니메이션동작 중 이상한 애니메이션을 찾아내서 데이터베이스에서 제거 후 사용해 문제해결에 용이함
애님 그래프에서 어떤 노드들이 실행되는지 플레이 되었던 몽타주 확인도 가능 애님 시퀀스에 노티파이까지 확인 가능
포즈서치항목에서 사용중인 데이터베이스와 어떤 포즈가 사용되는지 알 수 있다. 비용이 낮은 포즈가 사용되는 것도 볼 수 있다. 
Continuing Pose(지속포즈) : 모션 매칭 시스템이 불필요한 애니메이션 변경을 피하고 더 자연스러운 움직임을 만들 수 있게 해주는 중요한 메커니즘. 
불필요한 애니메이션 작동을 최소화하도록 하고 원리로는 현재 시스템은 매 프레임마다 현재 애니메이션이 다음 프레임에도 적절한지 평가후 적합하다고 평가하면 지속 이과정에서 바이어스값을 수정을해 줘서 실제비용을 더 낮아지도록 만들어주고 특정 시점에서 바이어스값 이상의 오차가 발생하면 유지할 필요 없다해서 다음포즈로 넘어감 
정리하여 장점으론 애니메이션 간의 불필요한 전환이 줄어들어 더 자연스럽게 보여짐
컴퓨터의 계산량을 덜어준다. 매순간 새로운 포즈를 검색할 필요가 없어진다 현재 동작이 적합하다면 현재 동작을 유지하면 되어 검색할 필요x 자원이 절약된다.

선택기 테이블 - 데이터베이스를 선택해주는 기능 상태를 업데이터를 하면선 선택기 테이블이 상태에 따라서 조건에 맞는 데이터베이스를 넘겨줌
              새로운 동작을 추가할 때 선택기 테이블에 조건을 추가하여 데이터베이스가 선택되도록 하자.
            
인터럽트 모드 - 모션 매칭이 데이터베이스를 변경하더라도 인터럽트 모드에 따라 자동으로 전환시기를 상황에 따라 조절한다.
데이터베이스가 변경될 때 바로될지 앞전에 재생 중인 애니메이션이 충분히 재생 후 변경될지 결정하는데 사용
ex) Idle -> Start walk -> Run 이런 경우 인터럽트 모드에 의해 시작 애님이 충분히 재생 후 그 다음 데이터베이스가 변경되도록함
    반대로 착지나 점프는 즉시 데이터베이스를 변경하여 애님을 바로 재생시킴

쓰레드 세이프 반환값은 ReturnValue를 유지한다

### 모션매치 사용 순서법 (아직 확실하지 않음)
선택기테이블에서 알맞는 아웃풋을 반환하여 가져온다
![image](https://github.com/user-attachments/assets/8232d2ec-f81f-4c8a-9ef0-f4fb0dcd788d)

모션 매치함수를 이용해서 몽타주를 반환한다
![image](https://github.com/user-attachments/assets/ba43cb90-0302-4e54-8964-0257da282961)

위에함수에서 이 포즈히스토리를 찾는데 이 역할을 정확히 모르겠다.
![image](https://github.com/user-attachments/assets/81ffcc54-e06e-40c1-8f96-0b135b60ad8c)
